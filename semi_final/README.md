# 파일 카빙 분산 처리 시스템

삭제된 JPEG 파일을 여러 컴퓨터에 분산하여 복구하는 네트워크 기반 파일 카빙 시스템입니다.

## 개요

디지털 포렌식에서 삭제된 파일을 복구할 때, 대용량 디스크 이미지를 처리하는 데 많은 시간과 리소스가 필요합니다. 이 시스템은 디스크 이미지를 여러 워커(Worker)에게 분산하여 병렬로 파일 카빙을 수행함으로써 복구 시간을 단축합니다.

## 주요 특징

- **대용량 이미지 지원**: 스트리밍 방식으로 30GB 이상의 디스크 이미지 처리 가능
- **분산 처리**: 여러 컴퓨터에서 동시에 파일 카빙 수행
- **메모리 효율적**: 4MB 단위 스트리밍으로 메모리 사용량 최소화
- **오버랩 처리**: 청크 경계에 걸친 파일도 완전히 복구
- **중복 제거**: MD5 해시 기반으로 중복 파일 자동 제거
- **JPEG 복구**: SOI(FF D8) ~ EOI(FF D9) 시그니처 기반 카빙

## 시스템 구조

```
┌─────────────────┐                              ┌─────────────────┐
│     Master      │ ────── 청크 데이터 ────────→ │    Worker 1     │
│   (서버 PC)     │ ←──── 복구된 JPEG ────────── │   (클라이언트)   │
│                 │                              └─────────────────┘
│  • DD 이미지    │                              ┌─────────────────┐
│  • 작업 분배    │ ────── 청크 데이터 ────────→ │    Worker 2     │
│  • 결과 수집    │ ←──── 복구된 JPEG ────────── │   (클라이언트)   │
│  • 중복 제거    │                              └─────────────────┘
└─────────────────┘                                      ...
```

## 동작 흐름

```
1. 마스터: DD 이미지 로드 및 서버 시작
              ↓
2. 워커들: 마스터에 연결 (30초 대기)
              ↓
3. 마스터: 이미지를 청크로 분할하여 스트리밍 전송
              ↓
4. 워커: 수신한 청크에서 JPEG 시그니처 검색 (카빙)
              ↓
5. 워커: 복구된 JPEG 파일들을 마스터로 스트리밍 전송
              ↓
6. 마스터: 중복 제거 후 최종 저장
```

## 파일 구성

| 파일 | 설명 |
|------|------|
| `file_carving_master.py` | 마스터 서버 (DD 이미지 분배, 결과 수집) |
| `file_carving_worker.py` | 워커 클라이언트 (JPEG 카빙 수행) |

## 설치

Python 3.7 이상이 필요합니다. 추가 라이브러리 설치는 필요하지 않습니다.

```bash
git clone https://github.com/yourusername/file-carving-distributed.git
cd file-carving-distributed
```

## 사용 방법

### 1. DD 이미지 준비

FTK Imager, dd 명령어 등을 사용하여 디스크 이미지를 생성합니다.

```bash
# Linux/Mac
sudo dd if=/dev/sdb of=usb_image.dd bs=4M status=progress

# Windows: FTK Imager 사용
# File → Create Disk Image → Raw (dd)
```

### 2. 마스터 서버 실행 (메인 PC)

```bash
python file_carving_master.py <이미지경로> [옵션]

# 예시
python file_carving_master.py usb_image.dd
python file_carving_master.py usb_image.dd --port 5000 --overlap 2
```

**옵션:**
| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--port`, `-p` | 서버 포트 | 5000 |
| `--overlap`, `-o` | 오버랩 크기 (MB) | 1 |
| `--block`, `-b` | 스트리밍 블록 크기 (MB) | 4 |
| `--output`, `-O` | 출력 디렉토리 | recovered_files |

### 3. 워커 실행 (다른 PC들)

마스터 서버가 실행된 후 30초 이내에 워커들을 연결합니다.

```bash
python file_carving_worker.py <마스터_IP> <포트>

# 예시
python file_carving_worker.py 192.168.1.100 5000
```

### 4. 결과 확인

마스터 PC의 `recovered_files/` 디렉토리에서 복구된 JPEG 파일들을 확인합니다.

## 오버랩(Overlap) 처리

JPEG 파일이 청크 경계에 걸쳐있을 수 있습니다:

```
청크 0                      청크 1
[......JPEG 시작]───────────[JPEG 끝......]
               ↑ 경계
```

이를 해결하기 위해 각 청크에 오버랩 영역을 추가합니다:

```
청크 0: [────────────────][오버랩]
청크 1:          [오버랩][────────────────]
                    ↑ 겹치는 영역
```

## 통신 프로토콜

### 메시지 형식

모든 메시지는 `길이 + 데이터` 형식으로 전송됩니다.

| 타입 | 길이 필드 | 최대 크기 |
|------|----------|----------|
| JSON | 4바이트 (`!I`) | ~4GB |
| Binary | 8바이트 (`!Q`) | ~16EB |

### 데이터 흐름

```
마스터 → 워커: [Task JSON] → [8바이트 길이] → [청크 데이터 스트림]
워커 → 마스터: [Result JSON] → ([File Meta JSON] → [8바이트 길이] → [JPEG 스트림]) × N
```

## 주요 클래스 및 함수

### 마스터 (file_carving_master.py)

| 함수 | 설명 |
|------|------|
| `load_dd_image()` | DD 이미지 파일 로드 |
| `start_server()` | 서버 시작 및 워커 연결 대기 |
| `distribute_and_collect()` | 청크 분배 및 결과 수집 |
| `send_binary_stream_from_file()` | 파일에서 직접 스트리밍 전송 |
| `recv_binary_stream_to_file()` | 스트리밍 수신 후 파일 저장 |
| `receive_results()` | 워커로부터 복구 결과 수신 |

### 워커 (file_carving_worker.py)

| 함수 | 설명 |
|------|------|
| `connect()` | 마스터 서버 연결 |
| `run_once()` | 태스크 수신 및 처리 |
| `recv_binary_stream_to_file()` | 청크를 임시 파일로 수신 |
| `carve_jpeg_from_file()` | 파일 기반 JPEG 카빙 |
| `send_binary_stream_from_file()` | 복구된 파일 스트리밍 전송 |

## 실행 예시

### 마스터 출력
```
[마스터] DD 이미지 로드: usb_image.dd
[마스터] 이미지 크기: 30,784,094,208 bytes (29358.00 MB)

[마스터] 서버 시작 - 포트: 5000
[마스터] 워커 연결 대기 중... (30초 타임아웃)
[마스터] 워커 연결됨: ('192.168.1.101', 49704)
[마스터] 워커 연결됨: ('192.168.1.102', 51234)

[마스터] 총 2개 워커 연결 완료

[마스터] 작업 분배 시작
  - 전체 크기: 30,784,094,208 bytes
  - 워커 수: 2
  - 청크 크기: ~15,392,047,104 bytes
  - 오버랩: 1,048,576 bytes

[마스터] 워커 0 (192.168.1.101)
  - 담당: 0 ~ 15,392,047,104
  - 전송: 0 ~ 15,392,571,392 (15,392,571,392 bytes)
  - 청크 전송 완료
  - 발견된 파일: 5개
    + 저장: recovered_1234567_a1b2c3d4.jpg (2,345,678 bytes)
    ...

============================================================
파일 카빙 완료 - 결과 요약
============================================================
총 복구 파일: 10개 (중복 제거됨)
총 복구 크기: 15,234,567 bytes (14.53 MB)
저장 위치: C:\recovered_files
```

## 제한사항

- 현재 JPEG 파일만 지원
- 워커 연결 대기 시간: 30초
- 네트워크 대역폭에 따라 대용량 이미지 처리 시간 증가
- 워커는 청크를 임시 파일로 저장하므로 충분한 디스크 공간 필요

## 향후 개선 사항

- [ ] PNG, GIF, PDF 등 추가 파일 형식 지원
- [ ] E01 (EnCase) 이미지 포맷 지원
- [ ] 병렬 워커 처리 (현재는 순차 처리)
- [ ] 진행률 표시 및 예상 시간
- [ ] 워커 재연결 지원
- [ ] GUI 인터페이스

## 라이선스

MIT License

## 참고자료

- [JPEG File Format](https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format)
- [File Carving](https://en.wikipedia.org/wiki/File_carving)
- [Python Socket Programming](https://docs.python.org/3/library/socket.html)
